<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase 画像アップロード</title>
</head>
<body>
    <h2>画像アップロード</h2>
    <input type="file" id="fileInput">
    <button onclick="uploadImage()">アップロード</button>
    <br><br>
    <button onclick="displayImages()">画像を表示</button>
    <div id="imageContainer"></div>

    <!-- Firebase SDK -->
    <script type="module">
        // Firebaseのインポート
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-storage.js";

        // Firebase 設定
        const firebaseConfig = {
            apiKey: "AIzaSyDvTy2ZeLzkFddvtyL3CD6mz13XBZw4i7w",
            authDomain: "image-7d588.firebaseapp.com",
            databaseURL: "https://image-7d588-default-rtdb.firebaseio.com",
            projectId: "image-7d588",
            storageBucket: "image-7d588.appspot.com",  // 修正
            messagingSenderId: "22500583815",
            appId: "1:22500583815:web:a74ab87dbe51b97b814b22",
            measurementId: "G-M4YEYNEKDV"
        };

        // Firebase 初期化
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // 画像アップロード
        async function uploadImage() {
            const file = document.getElementById('fileInput').files[0];
            if (!file) {
                alert("ファイルを選択してください");
                return;
            }

            const storageRef = ref(storage, 'images/' + file.name);

            try {
                // Firebase Storage にアップロード
                await uploadBytes(storageRef, file);
                const downloadURL = await getDownloadURL(storageRef);

                // Firestore にURLを保存
                await addDoc(collection(db, "images"), { url: downloadURL });

                alert("画像がアップロードされました！");
            } catch (error) {
                console.error("エラー:", error);
            }
        }

        // 画像を表示
        async function displayImages() {
            const imageContainer = document.getElementById("imageContainer");
            imageContainer.innerHTML = ""; // クリア

            try {
                const querySnapshot = await getDocs(collection(db, "images"));
                querySnapshot.forEach((doc) => {
                    const img = document.createElement("img");
                    img.src = doc.data().url;
                    img.width = 200;
                    img.style.margin = "10px";
                    imageContainer.appendChild(img);
                });
            } catch (error) {
                console.error("エラー:", error);
            }
        }
    </script>
</body>
</html>
